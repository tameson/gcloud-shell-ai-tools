#!/bin/bash
# Cloud Shell Environment Customization Script
# This runs automatically on Cloud Shell boot
# Tools installed here persist in $HOME across sessions

echo "=== Installing AI Coding Tools ==="

# Install uv (for uvx/bigquery-mcp)
if ! command -v uv &> /dev/null; then
    echo "Installing uv..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
fi
export PATH="$HOME/.local/bin:$PATH"

# Setup Node.js via nvm (Cloud Shell has nvm pre-installed)
export NVM_DIR="${NVM_DIR:-$HOME/.nvm}"
[ -s "$NVM_DIR/nvm.sh" ] && source "$NVM_DIR/nvm.sh"
# Also check system nvm location
[ -s "/usr/local/nvm/nvm.sh" ] && source "/usr/local/nvm/nvm.sh"

echo "Node version: $(node --version 2>/dev/null || echo 'not found')"
echo "npm version: $(npm --version 2>/dev/null || echo 'not found')"

echo "Installing Claude Code..."
npm install -g @anthropic-ai/claude-code || echo "Warning: Failed to install Claude Code"

echo "Installing Codex..."
npm install -g @openai/codex || echo "Warning: Failed to install Codex"

echo "Installing Ruler..."
npm install -g @intellectronica/ruler || echo "Warning: Failed to install Ruler"

# Fetch secrets from Secret Manager
echo "Fetching secrets from Secret Manager..."
PROJECT_ID="bi-project-392012"

ANTHROPIC_KEY=$(gcloud secrets versions access latest --secret="ai-tools-anthropic-key" --project="$PROJECT_ID" 2>/dev/null) || true
OPENAI_KEY=$(gcloud secrets versions access latest --secret="ai-tools-openai-key" --project="$PROJECT_ID" 2>/dev/null) || true
PRODUCT_SEARCH_TOKEN=$(gcloud secrets versions access latest --secret="ai-tools-product-search-token" --project="$PROJECT_ID" 2>/dev/null) || true

# Find the repo directory and run Ruler
REPO_DIR="$HOME/cloudshell_open/gcloud-shell-ai-tools"
if [ ! -d "$REPO_DIR" ]; then
    REPO_DIR="$(dirname "$(readlink -f "$0")")"
fi

if [ -d "$REPO_DIR/.ruler" ]; then
    echo "Running Ruler apply in $REPO_DIR..."
    cd "$REPO_DIR"
    ruler apply --no-gitignore || echo "Warning: Ruler apply failed"

    # Replace product_search token placeholder in generated MCP configs
    if [ -n "$PRODUCT_SEARCH_TOKEN" ]; then
        echo "Configuring product_search MCP token..."
        for f in .mcp.json .codex/config.toml .gemini/settings.json; do
            if [ -f "$f" ]; then
                sed -i "s|\${PRODUCT_SEARCH_TOKEN}|$PRODUCT_SEARCH_TOKEN|g" "$f"
            fi
        done
    fi
else
    echo "Warning: .ruler directory not found, skipping MCP configuration"
fi

# Save API keys
if [ -n "$ANTHROPIC_KEY" ] || [ -n "$OPENAI_KEY" ]; then
    echo "Saving API keys to ~/.ai-keys..."
    cat > "$HOME/.ai-keys" << EOF
export ANTHROPIC_API_KEY="$ANTHROPIC_KEY"
export OPENAI_API_KEY="$OPENAI_KEY"
EOF
    chmod 600 "$HOME/.ai-keys"

    # Add to bashrc if not already there
    if ! grep -q "source.*\.ai-keys" "$HOME/.bashrc" 2>/dev/null; then
        echo '[ -f "$HOME/.ai-keys" ] && source "$HOME/.ai-keys"' >> "$HOME/.bashrc"
    fi
    echo "API keys configured successfully"
else
    echo "Note: Could not fetch API keys (you may not have access to Secret Manager)"
fi

echo ""
echo "=== AI Tools Installation Complete ==="
echo "Run 'source ~/.bashrc' or start a new terminal to use the tools"
